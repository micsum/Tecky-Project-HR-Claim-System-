<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Claim Information</title>
    <link rel="stylesheet" href="create_claim.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/flowbite/1.6.4/flowbite.min.css" rel="stylesheet" />
    <link href="https://getbootstrap.com/docs/5.3/getting-started/introduction/" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/flowbite/1.6.4/flowbite.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography,aspect-ratio,line-clamp"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>  
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              clifford: '#da373d',
            }
          }
        },
       content:['./protected/claimInfo.html'],
      }
    </script>
     <style type="text/tailwindcss">
      @layer utilities {
        .content-auto {
          content-visibility: auto;
        }
      }
    </style>
</head>
<body>
    <div class="bg-gray-50 min-h-screen text-sm text-gray-700">

  <div class="bg-white shadow-card w-full pt-8 pb-4 sm:pt-10 sm:pb-6 mb-2">
    <div class="max-w-4xl mx-auto px-4">
      <img src="https://uxwing.com/wp-content/themes/uxwing/download/file-and-folder-type/claim-icon.png" alt="HelloClaims" class="mb-4 sm:mb-6 h-10 sm:h-12">
      <h1 class="text-xl sm:text-2xl font-semibold">Claim Application Approval</h1>
    </div>
  </div>
  <form action="claimInfo" method="GET" id="createClaim" enctype="multipart/form-data">
  <div class="max-w-4xl mx-auto">
    <section class="w-full border-b border-gray-200 px-4 py-6 flex flex-col md:flex-row">
      <div class="mb-4 mr-6 md:w-64">
        <h3 class="text-base font-semibold mb-1">Employee details</h3>
      </div>

      <div class="shadow-card bg-white sm:rounded -mx-4 sm:m-0 px-4 pt-5 pb-1 sm:px-5 flex flex-wrap justify-between md:w-full md:max-w-xl">

        <div class="field-group flex flex-col mb-4 w-full md:w-1/2">
          <label class="field-label mb-1" for="departmentId">Department</label>
          <input class="field md:mr-2 border  text-grey-700 rounded read-only:bg-gray-100" type="text" name="departmentId" id="departmentId" readonly>
        </div>
        <div class="field-group flex flex-col mb-4 w-full md:w-1/2">
          <label class="field-label mb-1 md:ml-2" for="employeeName">Name</label>
          <input class="field md:ml-2 border text-grey-700 rounded read-only:bg-gray-100" type="text" name="employeeName" id="employeeName" readonly>
        </div>
        <div class="field-group flex flex-col mb-4 w-1/2">
          <label class="field-label mb-1" for="email">Email</label>
          <input class="field mr-2 border text-grey-700 rounded read-only:bg-gray-100" type="text" name="email" id="email" readonly>
        </div>
        <div class="field-group flex flex-col mb-4 w-1/2">
          <label class="field-label mb-1 ml-2" for="last_name">Phone Number</label>
          <input class="field ml-2 border text-grey-700 rounded read-only:bg-gray-100" type="text" name="phoneNumber" id="phoneNumber" readonly>
        </div>
      </div>
    </section>
    
    
    <section class="w-full border-b border-gray-200 px-4 py-6 flex flex-col md:flex-row">
    
        <div class="mb-4 mr-6 md:w-64">
        <h3 class="text-base font-semibold">Claim Info</h3>
        <p class="text-grey-500" hidden>Please fill all required fields </p>

        <!--         <p class="text-grey-500">Secondary text could go here to help explain why we need this info</p> -->
        </div>
    
      <div class="shadow-card bg-white sm:rounded -mx-4 sm:m-0 px-4 pt-5 pb-1 sm:px-5 flex flex-wrap justify-between md:w-full md:max-w-xl">

        <div class="field-group flex flex-col mb-4 w-full">
          <label class="field-label mb-2 ml-2 required" for="catastrophe_event">Claim Type</label>
          <select name="type" id="type-select" class="field border ml-2 text-grey-700 rounded  read-only:bg-gray-100" readonly disabled>
            <option disabled selected value>Please select the claim type....</option>
            <option value="Advertising">Advertising</option>
            <option value="Allowance">Allowance</option>
            <option value="Meals">Meals</option>
            <option value="Education">Education</option>
            <option value="Medical">Medical</option>
            <option value="Expenses">Office expenses</option>
            <option value="Transportation">Transportation</option>
            <option value="Travel">Travel</option>
            <option value="Other">Other</option>
          </select>
        </div>

        <div class="field-group flex flex-col mb-4 w-full">
          <label class="field-label mb-2 ml-2 required" for="catastrophe_event">Claim Description</label>
          <input class="field ml-2 border text-grey-700 rounded read-only:bg-gray-100" type="text" name="claim_description" id="claim_d" readonly>
        </div>
        <div class="field-group flex flex-col mb-4 w-1/2">
            <label class="field-label mb-1 ml-2 required" for="last_name">Transaction Date</label>
            <input class="field ml-2 border text-grey-700 rounded read-only:bg-gray-100" type="date" name="t_date" id="t_date" readonly>
        </div>
        <div class="field-group flex flex-col mb-4 w-1/2">
            <label class="field-label mb-1 ml-2 required required:border-red-50" for="last_name">Amount</label>
            <input class="field ml-2 border text-grey-700 rounded read-only:bg-gray-100" type="text" name="amount" id="amount" placeholder="0.00" readonly >
        </div>
        <div class="field-group flex flex-col mb-4 w-full">
          <label class="field-label mb-2 ml-2 required" for="attachment">Uploaded Files</label>         
          <!--<input class="block w-full ml-2 text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-gray-50 dark:text-gray-400 focus:outline-none dark:bg-white-700 dark:border-gray-600 dark:placeholder-gray-400 read-only:bg-gray-100" 
          type="file" name="attachment" id="attachment" accept="image/*, .pdf,capture=camera" multiple readonly disabled hidden>-->
        </div>
        <div class="field-group flex flex-row mb-4 ml-2 w-full file-container preview">
        </div>
        <div class="field-group flex flex-col mb-4 w-full">
          <label class="field-label mb-2 ml-2" for="catastrophe_event" >Claim Status</label>
          <input class="field ml-2 border text-grey-700 rounded" type="text" name="claim_status" id="claim_status" readonly>
        </div>
        <div class="field-group flex flex-col mb-4 w-full reject">
          <label class="field-label mb-2 ml-2" for="catastrophe_event" >Rejected Reasons</label>
          <input class="field ml-2 border-red-200 text-gray-950 rounded read-only:bg-red-200"  type="text" name="reject_reasons" id="reject_reasons" readonly>
        </div>
   
    </div>
    </section>
    
    

    <section class="w-full border-b border-gray-200 px-4 py-6 flex flex-col md:flex-row">
    </section>

  </div>

</div>

<div class="bg-white w-full text-sm fixed bottom-0 left-0 border-t border-gray-200">
  <div class="max-w-4xl mx-auto px-4 flex flex-row justify-end pt-4 pb-5">
    <button class="btn" id="closeBtn">Close</button>
    <button class="btn btn-primary shadow-lg shadow-blue-800/50" id="update">Update Status</button>
  </div>
</div>
</form>

<script>
  //let employeeDbId;
  //let departmentDbId;
  //load info from db into employee table
 window.addEventListener("load", async()=>{ 

    const searchParams = new URLSearchParams(location.search);
    const id = searchParams.get("id");
    //console.log("claimId",id);
    let file_container = document.querySelector(".file-container");

    const resclaimFile = await fetch (`claimInfoFiles/${id}`,{
      method:"POST",
      headers:{"Content-Type":"application/json"}
    })
    const filesInfo = await resclaimFile.json()
    //console.log("files",filesInfo.filesname) //check files_name exist or not 
    let files = filesInfo.filesname  //show the uploaded files
    for(let i = 0; i<files.length;i++){
      //console.log(files[i].file_name) 
      const filename = files[i].file_name
      const url = `/uploads/${filename}`;
      let element;
      if(filename.endsWith('.pdf')){
        element=document.createElement('embed');
        element.setAttribute('src',url);
        element.setAttribute('type',"application/pdf");
      }else{
        element= document.createElement('img');
        element.setAttribute('src',url)
        element.setAttribute("class", "mx-3 preview-image")
        element.addEventListener("click",()=>{
          Swal.fire({
  imageUrl: element.src,
  showCloseButton: true,
  showConfirmButton: false,
  imageWidth:500,
})
        })
      }file_container.appendChild(element)

    }


    const resClaimInfo= await fetch (`/claimInfo?id=${id}`,{
      method:"POST",
      headers:{"Content-Type": "application/json"}
    })
    const claimInfo = await resClaimInfo.json();
    
    const selectedClaimInfo = claimInfo
    //console.log("selected claimInfo",selectedClaimInfo)
    const departmentId = document.querySelector("#departmentId");
    const employeeName = document.querySelector("#employeeName");
    const email = document.querySelector("#email");
    const phoneNumber = document.querySelector("#phoneNumber");
    const claim_type = document.querySelector("#type-select");
    const claim_description = document.querySelector("#claim_d");
    const claim_date = document.querySelector("#t_date");
    const claim_amount = document.querySelector("#amount");
    const claim_status = document.querySelector("#claim_status")
    const reject_reasons = document.querySelector("#reject_reasons")
    
    departmentId.value = selectedClaimInfo.department_name
    employeeName.value = selectedClaimInfo.employee_name
    email.value = selectedClaimInfo.email
    phoneNumber.value = selectedClaimInfo.employee_phonenumber
    claim_type.value = selectedClaimInfo.claim_type
    claim_description.value = selectedClaimInfo.claim_description
    claim_date.value = selectedClaimInfo.transaction_date.slice(0,10)
    claim_amount.value = selectedClaimInfo.amount
    claim_status.value = selectedClaimInfo.status
    reject_reasons.value = selectedClaimInfo.reject_reasons
    let role = selectedClaimInfo.role


    let updateStatus = document.querySelector("#update")
    if((claim_status.value === "Approved" || claim_status.value==="Rejected") && role==="admin"){
      updateStatus.setAttribute("class","bg-blue-500 text-white font-bold py-2 px-4 rounded opacity-50 cursor-not-allowed")
      updateStatus.setAttribute("disabled","true")
    }

    if(role==="user"){
      updateStatus.setAttribute("class","bg-blue-500 text-white font-bold py-2 px-4 rounded opacity-50 cursor-not-allowed invisible")
    }
    
    if(claim_status.value === "Approved"){
      claim_status.setAttribute("class", "field ml-2 border-teal-300 text-grey-700 rounded read-only:bg-emerald-400")
    }else if(claim_status.value === "Rejected"){
      claim_status.setAttribute("class", "field ml-2 border-red-300	 text-grey-700 rounded read-only:bg-red-400")
    }else{
      claim_status.setAttribute("class", "field ml-2 border-zinc-300 text-grey-700 rounded read-only:bg-zinc-400")

    }

    let rejectDiv = document.querySelector(".reject")
    if(claim_status.value != "Rejected"){
      rejectDiv.setAttribute("class","invisible")
    }
 //   const res = await fetch (`/getEmployee?id=${id}`, {
 //       method:"GET",
 //       headers:{"Content-Type": "application/json"},
 //     });
 //     const employeeList = await res.json()
 //     //console.log(employeeList) //check the employee list
 //    const departmentId = document.querySelector("#departmentId");
 //    const employeeName = document.querySelector("#employeeName");
 //    const email = document.querySelector("#email");
 //    const phoneNumber = document.querySelector("#phoneNumber");
//
 //    departmentId.value=employeeList.department_name
 //    employeeName.value=employeeList.name
 //    email.value=employeeList.email
 //    phoneNumber.value=employeeList.phone_number
 //    employeeDbId = employeeList.id
 //    departmentDbId = employeeList.department_id
    }
  )

let sameAdminId;
let updateStatus = document.querySelector("#update")
updateStatus.addEventListener("click",(e)=>{
  e.preventDefault();

Swal.mixin({
  customClass: {
    confirmButton: 'btn btn-success',
    cancelButton: 'btn btn-danger'
  },
  buttonsStyling: false
})
const searchParams = new URLSearchParams(location.search);
 const id = searchParams.get("id");
Swal.fire({
  title: 'Update Claim Status?',
  text: "You won't be able to revert this!",
  icon: 'question',
  showCancelButton: true,
  showCloseButton:true,
  confirmButtonText: 'Approve',
  confirmButtonColor:'#45B08C',
  cancelButtonText: 'Reject',
  cancelButtonColor:'#D10000',
  preConfirm: async()=>{
    const res = await fetch(`/claimInfo/${id}`,{
      method:"POST",
      headers:{"Content-Type": "application/json"},
      body: JSON.stringify({status:"approved"})
    })
    const result = await res.json()
    console.log("statusA", result.status)
    if(result.adminId){
    console.log("duplicate",result.adminId)
    sameAdminId = result.adminId
    } 
  },
 
  reverseButtons: true,
}).then((result) => {
  if (result.isConfirmed && sameAdminId) {
    Swal.fire(
      'Error!',
      'You can not approve your own claim.',
      'warning',
    ).then(function(){
      window.location.reload()
    })
  } else if(result.isConfirmed){
    Swal.fire(
      'Approved!',
      'Claim has been approved.',
      'success',
    ).then(function(){
      window.location.reload()
    })
  }
  else if (
    result.dismiss === Swal.DismissReason.cancel
  ) {
  const {value:text} = Swal.fire({
  input: 'textarea',
  inputLabel: 'Reject Reasons',
  inputPlaceholder: 'Type your reasons here...',
  inputAttributes: {
    'aria-label': 'Type your reasons here'
  },
  showCancelButton: true,  
  showCloseButton:true,
  showDenyButton:true,
  denyButtonText:"Confirm to Reject",
  denyButtonColor: "#D10000",
  showConfirmButton:false,
  returnInputValueOnDeny:true,
  preDeny: async(text)=>{
    //console.log("deny")
    const res =await fetch(`/claimInfo/${id}`,{
      method:"POST",
      headers:{"Content-Type": "application/json"},
      body: JSON.stringify({status:"rejected", rejectReasons: text})
    })


    const result = await res.json()
   //console.log("statusR", result.status)
    console.log("duplicate",result.adminId)    
    if(result.adminId){
      Swal.fire(
      'Error!',
      'You can not approve your own claim.',
      'warning',
    ).then(function(){
      window.location.reload()
    })
    }
    //console.log("text",text) //text from textarea 
    //console.log("reasons",statusResult.rejectId) test reject id
    else{Swal.fire({
      title:"Rejected",
      text:"Claim has been rejected.",
      icon:"error"
    }).then(function(){
      window.location.reload()
    })} 
  },
  
  
})
  }
})})


const closeBtn = document.querySelector("#closeBtn")
closeBtn.addEventListener("click",function(event){
  event.preventDefault();
  window.close()
})



</script>
</body>
</html>