<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Claim Page</title>
    <link rel="stylesheet" href="create_claim.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/flowbite/1.6.4/flowbite.min.css" rel="stylesheet" />
    <link href="https://getbootstrap.com/docs/5.3/getting-started/introduction/" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/flowbite/1.6.4/flowbite.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography,aspect-ratio,line-clamp"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>  
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              clifford: '#da373d',
            }
          }
        }
      }
    </script>
     <style type="text/tailwindcss">
      @layer utilities {
        .content-auto {
          content-visibility: auto;
        }
      }
    </style>
</head>
<body>
    <div class="bg-gray-50 min-h-screen text-sm text-gray-700">

  <div class="bg-white shadow-card w-full pt-8 pb-4 sm:pt-10 sm:pb-6 mb-2">
    <div class="max-w-4xl mx-auto px-4">
      <img src="https://uxwing.com/wp-content/themes/uxwing/download/file-and-folder-type/claim-icon.png" alt="HelloClaims" class="mb-4 sm:mb-6 h-10 sm:h-12">
      <h1 class="text-xl sm:text-2xl font-semibold">Claim Application</h1>
    </div>
  </div>
  <form action="/create_claim" method="POST" id="createClaim" enctype="multipart/form-data">
  <div class="max-w-4xl mx-auto">
    <section class="w-full border-b border-gray-200 px-4 py-6 flex flex-col md:flex-row">
      <div class="mb-4 mr-6 md:w-64">
        <h3 class="text-base font-semibold mb-1">Employee details</h3>
      </div>

      <div class="shadow-card bg-white sm:rounded -mx-4 sm:m-0 px-4 pt-5 pb-1 sm:px-5 flex flex-wrap justify-between md:w-full md:max-w-xl">

        <div class="field-group flex flex-col mb-4 w-full md:w-1/2">
          <label class="field-label mb-1" for="departmentId">Department</label>
          <input class="field md:mr-2 border  text-grey-700 rounded read-only:bg-gray-100" type="text" name="departmentId" id="departmentId" readonly>
        </div>
        <div class="field-group flex flex-col mb-4 w-full md:w-1/2">
          <label class="field-label mb-1 md:ml-2" for="employeeName">Name</label>
          <input class="field md:ml-2 border text-grey-700 rounded read-only:bg-gray-100" type="text" name="employeeName" id="employeeName" readonly>
        </div>
        <div class="field-group flex flex-col mb-4 w-1/2">
          <label class="field-label mb-1" for="email">Email</label>
          <input class="field mr-2 border text-grey-700 rounded read-only:bg-gray-100" type="text" name="email" id="email" readonly>
        </div>
        <div class="field-group flex flex-col mb-4 w-1/2">
          <label class="field-label mb-1 ml-2" for="last_name">Phone Number</label>
          <input class="field ml-2 border text-grey-700 rounded read-only:bg-gray-100" type="text" name="phoneNumber" id="phoneNumber" readonly>
        </div>
      </div>
    </section>
    
    
    <section class="w-full border-b border-gray-200 px-4 py-6 flex flex-col md:flex-row">
    
        <div class="mb-4 mr-6 md:w-64">
        <h3 class="text-base font-semibold">Claim Info</h3>
        <p class="text-grey-500">Please fill all required fields </p>

        <!--         <p class="text-grey-500">Secondary text could go here to help explain why we need this info</p> -->
        </div>
    
      <div class="shadow-card bg-white sm:rounded -mx-4 sm:m-0 px-4 pt-5 pb-1 sm:px-5 flex flex-wrap justify-between md:w-full md:max-w-xl">

        <div class="field-group flex flex-col mb-4 w-full">
          <label class="field-label mb-2 ml-2 required" for="catastrophe_event">Claim Type</label>
          <select name="type" id="type-select" class="field border ml-2 text-grey-700 rounded  read-only:bg-gray-100" readonly disabled>
            <option disabled selected value>Please select the claim type....</option>
            <option value="Advertising">Advertising</option>
            <option value="Allowance">Allowance</option>
            <option value="Meals">Meals</option>
            <option value="Education">Education</option>
            <option value="Medical">Medical</option>
            <option value="Expenses">Office expenses</option>
            <option value="Transportation">Transportation</option>
            <option value="Travel">Travel</option>
            <option value="Other">Other</option>
          </select>
        </div>

        <div class="field-group flex flex-col mb-4 w-full">
          <label class="field-label mb-2 ml-2 required" for="catastrophe_event">Claim Description</label>
          <input class="field ml-2 border text-grey-700 rounded read-only:bg-gray-100" type="text" name="claim_description" id="claim_d" readonly>
        </div>
        <div class="field-group flex flex-col mb-4 w-1/2">
            <label class="field-label mb-1 ml-2 required" for="last_name">Transaction Date</label>
            <input class="field ml-2 border text-grey-700 rounded read-only:bg-gray-100" type="date" name="t_date" id="t_date" readonly>
        </div>
        <div class="field-group flex flex-col mb-4 w-1/2">
            <label class="field-label mb-1 ml-2 required required:border-red-50" for="last_name">Amount</label>
            <input class="field ml-2 border text-grey-700 rounded read-only:bg-gray-100" type="text" name="amount" id="amount" placeholder="0.00" readonly >
        </div>
        <div class="field-group flex flex-col mb-4 w-full">
          <label class="field-label mb-2 ml-2 required" for="attachment">Upload File</label>         
          <input class="block w-full ml-2 text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-gray-50 dark:text-gray-400 focus:outline-none dark:bg-white-700 dark:border-gray-600 dark:placeholder-gray-400 read-only:bg-gray-100" 
          type="file" name="attachment" id="attachment" accept="image/*, .pdf,capture=camera" multiple readonly disabled>
        </div>
        <div class="field-group flex flex-row mb-4 ml-2 w-full preview">
        </div>
        <div class="field-group flex flex-col mb-4 w-full">
          <label class="field-label mb-2 ml-2" for="catastrophe_event" hidden>Claim Status</label>
          <input class="field ml-2 border text-grey-700 rounded read-only:bg-gray-100" value="Pending" type="hidden" name="claim_status" id="claim_status" readonly>
        </div>
   
    </div>
    </section>
    
    

    <section class="w-full border-b border-gray-200 px-4 py-6 flex flex-col md:flex-row">
    </section>

  </div>

</div>

<div class="bg-white w-full text-sm fixed bottom-0 left-0 border-t border-gray-200">
  <div class="max-w-4xl mx-auto px-4 flex flex-row justify-end pt-4 pb-5">
    <button class="btn" id="closeBtn">Close</button>
    <button class="btn btn-primary" id="preview">Preview</button>
<div id="popup-container">
  <div id="popup-content">
    <h3>Claim Preview</h3>
    <ul id="preview-list"></ul>
    <button class="btn" id="close-popup">Close</button>
    <button class="btn btn-primary" id="submit" type="submit">Submit</button>
  </div>
</div>
  </div>
</div>
</form>

<script>
  let employeeDbId;
  let departmentDbId;
  //load info from db into employee table
 window.addEventListener("load", async()=>{ 

    const searchParams = new URLSearchParams(location.search);
    const id = searchParams.get("id");
    console.log(id);

    const resClaimRecord = await fetch (`/claimOneRecord?id=${id}`);
    const claimRecord = await resClaimRecord.json();
    console.log(claimRecord)
    const claimRecordData = claimRecord[0]
 //   const departmentId = document.querySelector("#departmentId");
 //   const employeeName = document.querySelector("#employeeName");
 //   const email = document.querySelector("#email");
 //   const phoneNumber = document.querySelector("#phoneNumber");
    const claim_type = document.querySelector("#type-select");
    const claim_description = document.querySelector("#claim_d");
    const claim_date = document.querySelector("#t_date");
    const claim_amount = document.querySelector("#amount");
    
  //   departmentId.value = claimRecordData.department.id
  //   employeeName.value = claimRecordData.employee_name
  //   email.value = claimRecordData.email
  //   phoneNumber.value = 
    claim_type.value = claimRecordData.claim_type
    claim_description.value = claimRecordData.claim_description
    claim_date.value = claimRecordData.transaction_date.slice(0,10)
    claim_amount.value = claimRecordData.amount


    console.log(claimRecordData);
    console.log(claimRecordData.claim_type)



 //   const res = await fetch (`/getEmployee?id=${id}`, {
 //       method:"GET",
 //       headers:{"Content-Type": "application/json"},
 //     });
 //     const employeeList = await res.json()
 //     //console.log(employeeList) //check the employee list
 //    const departmentId = document.querySelector("#departmentId");
 //    const employeeName = document.querySelector("#employeeName");
 //    const email = document.querySelector("#email");
 //    const phoneNumber = document.querySelector("#phoneNumber");
//
 //    departmentId.value=employeeList.department_name
 //    employeeName.value=employeeList.name
 //    email.value=employeeList.email
 //    phoneNumber.value=employeeList.phone_number
 //    employeeDbId = employeeList.id
 //    departmentDbId = employeeList.department_id
    }
  )






  let createClaim = document.querySelector("#createClaim");
  createClaim.addEventListener("submit", async function (event) {
    event.preventDefault();
    const attachment = event.target;
    const attachData = new FormData(attachment);
    let claimTypeText = document.querySelector('select[name="type"] option:checked').textContent
   attachData.append("employeeDbId", employeeDbId)
   attachData.append("departmentDbId", departmentDbId)
   attachData.append("claimTypeText", claimTypeText)



   const res = await fetch("/create_claim", {
     method: "POST",
     body: attachData,
   });
   const result = await res.json();
   console.log(result)
   //document.querySelector(".preview").textContent = console.log(result); show the sucess:true result
  });

  let attachInput = document.querySelector("#attachment");
  attachInput.addEventListener("change", preview);
  function preview(e) {
  let fileObject = this.files;
  if(fileObject.length>4){
    e.preventDefault();
    Swal.fire({
  icon: 'error',
  title: 'Error uploading files:',
  text: 'Maximum Upload 4 files',
})
e.target.value="";
  }else {
  for (let i = 0; i < fileObject.length; i++) {
    let fileReader = new FileReader();
    if(fileObject[i].type ==="image/jpeg" || "image/bmp" || "image/png"){
    fileReader.readAsDataURL(fileObject[i]);
    fileReader.onload = function () {
      let result = fileReader.result;
      let preview = document.createElement("img");
      preview.setAttribute("src", result);
      preview.setAttribute("class", "preview-image");
      preview.setAttribute("class", "mx-3");
      document.querySelector(".preview").appendChild(preview);
    };}}}}

const previewBtn = document.querySelector("#preview");
const popupContainer = document.querySelector("#popup-container");
const popupContent = document.querySelector("#popup-content");
const previewList = document.querySelector("#preview-list");
const closePopupBtn = document.querySelector("#close-popup");
const  submitBtn = document.querySelector("#submit");

previewBtn.addEventListener('click', function(event) {
  // Prevent default form submission behavior
  event.preventDefault();

  // Get form data
  const formData = new FormData(createClaim);
  const claimData = {
    Department: formData.get('departmentId'),
    "Employee Name": formData.get('employeeName'),
    Email: formData.get('email'),
    "Phone Number": formData.get('phoneNumber'),
    "Claim Type": document.querySelector('select[name="type"] option:checked').textContent,
    "Claim Amount": formData.get('amount'),
    "Claim Description": formData.get('claim_description'),
    attachments: formData.get('attachment')
  };

  // Display preview page with claim data
  displayClaimPreview(claimData);
});

function displayClaimPreview(claimData) {
  // Populate the list with claim data
  previewList.innerHTML = '';
  for (const [key, value] of Object.entries(claimData)) {
    const listItem = document.createElement('li');
    listItem.innerHTML = `<strong>${key}:</strong> ${value}`;
    previewList.appendChild(listItem);
  }

  // Show the popup dialog
  popupContainer.style.display = "block";
}


submitBtn.addEventListener("click",function(event){
  Swal.fire({
  icon: 'success',
  title: 'Submitted',
  showCloseButton: true,
  text: 'Your claim has been submitted!',
})
popupContainer.style.display="none";  
})


closePopupBtn.addEventListener('click', function(event) {
  // Hide the popup dialog
  event.preventDefault()
  popupContainer.style.display = "none";
});


const closeBtn = document.querySelector("#closeBtn")
closeBtn.addEventListener("click",function(event){
  event.preventDefault();
})
</script>
</body>
</html>